"""
é…ç½®æ–‡ä»¶ç›‘æ§å™¨
ç›‘æ§trading_config_vps.jsonæ–‡ä»¶çš„å˜åŒ–ï¼Œå¹¶å¤„ç†äº¤æ˜“å¯¹å˜æ›´
"""

import json
import os
from datetime import datetime
from typing import Any, Dict, List, Optional


class ConfigMonitor:
    """é…ç½®æ–‡ä»¶ç›‘æ§å™¨"""

    def __init__(self, config_path: str):
        """
        åˆå§‹åŒ–é…ç½®ç›‘æ§å™¨

        Args:
            config_path: é…ç½®æ–‡ä»¶è·¯å¾„
        """
        self.config_path = config_path
        self.last_modified_time: Optional[float] = None
        self.current_config: Optional[Dict[str, Any]] = None
        self.current_symbols: List[str] = []

        # åˆå§‹åŒ–ï¼šè®°å½•å½“å‰é…ç½®å’Œä¿®æ”¹æ—¶é—´
        self._update_state()

    def _get_file_modified_time(self) -> float:
        """è·å–é…ç½®æ–‡ä»¶çš„ä¿®æ”¹æ—¶é—´"""
        try:
            return os.path.getmtime(self.config_path)
        except Exception as e:
            print(f"âš ï¸ æ— æ³•è·å–é…ç½®æ–‡ä»¶ä¿®æ”¹æ—¶é—´: {e}")
            return 0.0

    def _load_config(self) -> Dict[str, Any]:
        """åŠ è½½é…ç½®æ–‡ä»¶"""
        try:
            with open(self.config_path, "r", encoding="utf-8") as f:
                return json.load(f)
        except Exception as e:
            print(f"âš ï¸ æ— æ³•åŠ è½½é…ç½®æ–‡ä»¶: {e}")
            return {}

    def _update_state(self):
        """æ›´æ–°å½“å‰çŠ¶æ€"""
        self.last_modified_time = self._get_file_modified_time()
        self.current_config = self._load_config()
        self.current_symbols = self.current_config.get("trading", {}).get("symbols", [])

    def check_for_updates(self) -> Dict[str, Any]:
        """
        æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦æœ‰æ›´æ–°

        Returns:
            {
            'updated': bool,  # æ˜¯å¦æœ‰æ›´æ–°
                'symbols_changed': bool,  # äº¤æ˜“å¯¹æ˜¯å¦å˜åŒ–
                'old_symbols': List[str],  # æ—§çš„äº¤æ˜“å¯¹åˆ—è¡¨
                'new_symbols': List[str],  # æ–°çš„äº¤æ˜“å¯¹åˆ—è¡¨
                'removed_symbols': List[str],  # éœ€è¦å¹³ä»“çš„äº¤æ˜“å¯¹
                'new_config': Dict[str, Any]  # æ–°çš„é…ç½®
            }
        """
        result = {
            "updated": False,
            "symbols_changed": False,
            "old_symbols": self.current_symbols.copy(),
            "new_symbols": [],
            "removed_symbols": [],
            "added_symbols": [],
            "new_config": None,
        }

        # è·å–å½“å‰æ–‡ä»¶ä¿®æ”¹æ—¶é—´
        current_mtime = self._get_file_modified_time()

        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦è¢«ä¿®æ”¹ï¼ˆéœ€è¦å¤„ç†Noneçš„æƒ…å†µï¼‰
        if self.last_modified_time is None or current_mtime <= self.last_modified_time:
            return result

        # æ–‡ä»¶å·²æ›´æ–°
        result["updated"] = True

        # åŠ è½½æ–°é…ç½®
        new_config = self._load_config()
        new_symbols = new_config.get("trading", {}).get("symbols", [])

        result["new_symbols"] = new_symbols
        result["new_config"] = new_config

        # æ£€æŸ¥äº¤æ˜“å¯¹æ˜¯å¦å˜åŒ–
        if set(new_symbols) != set(self.current_symbols):
            result["symbols_changed"] = True

            # æ‰¾å‡ºè¢«ç§»é™¤çš„äº¤æ˜“å¯¹ï¼ˆéœ€è¦å¹³ä»“ï¼‰
            result["removed_symbols"] = [
                symbol for symbol in self.current_symbols if symbol not in new_symbols
            ]

            # æ‰¾å‡ºæ–°å¢çš„äº¤æ˜“å¯¹
            result["added_symbols"] = [
                symbol for symbol in new_symbols if symbol not in self.current_symbols
            ]

        return result

    def apply_updates(self, update_info: Dict[str, Any]):
        """
        åº”ç”¨é…ç½®æ›´æ–°

        Args:
            update_info: check_for_updatesè¿”å›çš„æ›´æ–°ä¿¡æ¯
        """
        if not update_info["updated"]:
            return

        # æ›´æ–°çŠ¶æ€
        self._update_state()

        # è®°å½•æ—¥å¿—
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        print(f"\n{'=' * 60}")
        print(f"ğŸ“ é…ç½®æ–‡ä»¶å·²æ›´æ–° [{timestamp}]")
        print(f"{'=' * 60}")

        if update_info["symbols_changed"]:
            print("âš ï¸  äº¤æ˜“å¯¹å‘ç”Ÿå˜åŒ–:")
            print(f"   æ—§äº¤æ˜“å¯¹: {', '.join(update_info['old_symbols'])}")
            print(f"   æ–°äº¤æ˜“å¯¹: {', '.join(update_info['new_symbols'])}")

            if update_info["removed_symbols"]:
                print(f"   éœ€è¦å¹³ä»“: {', '.join(update_info['removed_symbols'])}")

            if update_info["added_symbols"]:
                print(f"   æ–°å¢äº¤æ˜“å¯¹: {', '.join(update_info['added_symbols'])}")
        else:
            print("âœ… äº¤æ˜“å¯¹æœªå˜åŒ–ï¼Œå‚æ•°å·²æ›´æ–°")

        print(f"{'=' * 60}\n")

    def get_current_symbols(self) -> List[str]:
        """è·å–å½“å‰çš„äº¤æ˜“å¯¹åˆ—è¡¨"""
        return self.current_symbols.copy()

    def get_current_config(self) -> Dict[str, Any]:
        """è·å–å½“å‰çš„é…ç½®"""
        return self.current_config.copy() if self.current_config else {}
