"""
å¯¹æ¯”ä¸‰ä¸ªç‰ˆæœ¬çš„å›æµ‹ç»“æœ
"""
import pandas as pd
import sys
import io

# è®¾ç½®è¾“å‡ºç¼–ç ä¸ºUTF-8
sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')

print("="*80)
print("ä¸‰ç‰ˆæœ¬ç­–ç•¥å¯¹æ¯”åˆ†æ")
print("="*80)

# è¯»å–ä¸‰ä¸ªç‰ˆæœ¬çš„äº¤æ˜“è®°å½•
trades_v1 = pd.read_csv('logs/backtest_trades_20260201_120116.csv')  # V1: åŸå§‹ç‰ˆæœ¬
trades_v2 = pd.read_csv('logs/backtest_trades_20260201_120557.csv')  # V2: ä¼˜åŒ–ç‰ˆæœ¬
trades_v3 = pd.read_csv('logs/backtest_trades_20260201_120830.csv')  # V3: è¿›ä¸€æ­¥ä¼˜åŒ–

def analyze_trades(trades_df, version_name):
    win = trades_df[trades_df['pnl'] > 0]
    loss = trades_df[trades_df['pnl'] <= 0]
    
    return {
        'name': version_name,
        'total_trades': len(trades_df),
        'win_trades': len(win),
        'loss_trades': len(loss),
        'win_rate': len(win) / len(trades_df) * 100,
        'total_pnl': trades_df['pnl'].sum(),
        'return_pct': (trades_df['pnl'].sum() / 10000) * 100,
        'avg_pnl': trades_df['pnl'].mean(),
        'avg_win': win['pnl'].mean() if len(win) > 0 else 0,
        'avg_loss': loss['pnl'].mean() if len(loss) > 0 else 0,
        'profit_ratio': abs(win['pnl'].mean() / loss['pnl'].mean()) if len(loss) > 0 and loss['pnl'].mean() != 0 else float('inf'),
        'profit_factor': abs(win['pnl'].sum() / loss['pnl'].sum()) if len(loss) > 0 and loss['pnl'].sum() != 0 else float('inf'),
        'max_win': win['pnl'].max() if len(win) > 0 else 0,
        'max_loss': loss['pnl'].min() if len(loss) > 0 else 0,
    }

v1 = analyze_trades(trades_v1, "V1")
v2 = analyze_trades(trades_v2, "V2")
v3 = analyze_trades(trades_v3, "V3")

print("\n" + "="*80)
print("ç‰ˆæœ¬å‚æ•°å¯¹æ¯”")
print("="*80)
print(f"{'æŒ‡æ ‡':<20} {'V1 (åŸå§‹)':<25} {'V2 (ä¼˜åŒ–1)':<25} {'V3 (ä¼˜åŒ–2)':<25}")
print("-"*80)
print(f"{'æ­¢æŸ':<20} {'2%':<25} {'1.5%':<25} {'1.5%':<25}")
print(f"{'æ­¢ç›ˆ':<20} {'3%':<25} {'4%':<25} {'5%':<25}")
print(f"{'RSIé˜ˆå€¼':<20} {'30/70':<25} {'35/65':<25} {'32/68':<25}")
print(f"{'è¶‹åŠ¿è¿‡æ»¤':<20} {'æ— ':<25} {'æ— ':<25} {'MA20è¿‡æ»¤':<25}")

print("\n" + "="*80)
print("å…³é”®æŒ‡æ ‡å¯¹æ¯”")
print("="*80)
print(f"{'æŒ‡æ ‡':<20} {'V1':<15} {'V2':<15} {'V3':<15} {'V1â†’V3å˜åŒ–':<20}")
print("-"*80)

# æ”¶ç›Šå¯¹æ¯”
print(f"{'æ€»æ”¶ç›Š':<20} ${v1['total_pnl']:<14.2f} ${v2['total_pnl']:<14.2f} ${v3['total_pnl']:<14.2f} +${v3['total_pnl']-v1['total_pnl']:.2f} ({(v3['total_pnl']/v1['total_pnl']-1)*100:+.1f}%)")
print(f"{'æ”¶ç›Šç‡':<20} {v1['return_pct']:<14.2f}% {v2['return_pct']:<14.2f}% {v3['return_pct']:<14.2f}% {v3['return_pct']-v1['return_pct']:+.2f}%")

# äº¤æ˜“ç»Ÿè®¡
print(f"{'äº¤æ˜“æ¬¡æ•°':<20} {v1['total_trades']:<15} {v2['total_trades']:<15} {v3['total_trades']:<15} {v3['total_trades']-v1['total_trades']:+d} ({(v3['total_trades']/v1['total_trades']-1)*100:+.1f}%)")
print(f"{'èƒœç‡':<20} {v1['win_rate']:<14.1f}% {v2['win_rate']:<14.1f}% {v3['win_rate']:<14.1f}% {v3['win_rate']-v1['win_rate']:+.1f}%")

# ç›ˆäºåˆ†æ
print(f"{'å¹³å‡ç›ˆäº':<20} ${v1['avg_pnl']:<14.2f} ${v2['avg_pnl']:<14.2f} ${v3['avg_pnl']:<14.2f} ${v3['avg_pnl']-v1['avg_pnl']:+.2f}")
print(f"{'å¹³å‡ç›ˆåˆ©':<20} ${v1['avg_win']:<14.2f} ${v2['avg_win']:<14.2f} ${v3['avg_win']:<14.2f} ${v3['avg_win']-v1['avg_win']:+.2f}")
print(f"{'å¹³å‡äºæŸ':<20} ${v1['avg_loss']:<14.2f} ${v2['avg_loss']:<14.2f} ${v3['avg_loss']:<14.2f} ${v3['avg_loss']-v1['avg_loss']:+.2f}")
print(f"{'ç›ˆäºæ¯”':<20} {v1['profit_ratio']:<14.2f} {v2['profit_ratio']:<14.2f} {v3['profit_ratio']:<14.2f} {v3['profit_ratio']-v1['profit_ratio']:+.2f}")
print(f"{'ç›ˆåˆ©å› å­':<20} {v1['profit_factor']:<14.2f} {v2['profit_factor']:<14.2f} {v3['profit_factor']:<14.2f} {v3['profit_factor']-v1['profit_factor']:+.2f}")

print("\n" + "="*80)
print("ğŸ“Š æ€§èƒ½æ’å")
print("="*80)

metrics = [
    ('æ€»æ”¶ç›Š', [v1['total_pnl'], v2['total_pnl'], v3['total_pnl']], 'è¶Šé«˜è¶Šå¥½'),
    ('èƒœç‡', [v1['win_rate'], v2['win_rate'], v3['win_rate']], 'è¶Šé«˜è¶Šå¥½'),
    ('ç›ˆäºæ¯”', [v1['profit_ratio'], v2['profit_ratio'], v3['profit_ratio']], 'è¶Šé«˜è¶Šå¥½'),
    ('å¹³å‡äºæŸ', [abs(v1['avg_loss']), abs(v2['avg_loss']), abs(v3['avg_loss'])], 'è¶Šä½è¶Šå¥½'),
    ('äº¤æ˜“æ¬¡æ•°', [v1['total_trades'], v2['total_trades'], v3['total_trades']], 'é€‚ä¸­æœ€å¥½'),
]

versions = ['V1', 'V2', 'V3']
for metric_name, values, note in metrics:
    if 'è¶Šä½è¶Šå¥½' in note:
        best_idx = values.index(min(values))
    elif 'é€‚ä¸­æœ€å¥½' in note:
        # äº¤æ˜“æ¬¡æ•°ï¼š40-60æ¬¡ä¸ºé€‚ä¸­
        distances = [abs(v - 50) for v in values]
        best_idx = distances.index(min(distances))
    else:
        best_idx = values.index(max(values))
    
    print(f"{metric_name:<15} ğŸ† {versions[best_idx]:<5} ({note})")

print("\n" + "="*80)
print("ğŸ¯ æœ€ç»ˆæ¨è")
print("="*80)

# ç»¼åˆè¯„åˆ†
scores = {
    'V1': 0,
    'V2': 0,
    'V3': 0
}

# æ€»æ”¶ç›Šæƒé‡40%
if v3['total_pnl'] >= max(v1['total_pnl'], v2['total_pnl']):
    scores['V3'] += 40
elif v2['total_pnl'] >= v1['total_pnl']:
    scores['V2'] += 40
else:
    scores['V1'] += 40

# ç›ˆäºæ¯”æƒé‡30%
if v3['profit_ratio'] >= max(v1['profit_ratio'], v2['profit_ratio']):
    scores['V3'] += 30
elif v2['profit_ratio'] >= v1['profit_ratio']:
    scores['V2'] += 30
else:
    scores['V1'] += 30

# é£é™©æ§åˆ¶ï¼ˆå¹³å‡äºæŸï¼‰æƒé‡20%
if abs(v3['avg_loss']) <= min(abs(v1['avg_loss']), abs(v2['avg_loss'])):
    scores['V3'] += 20
elif abs(v2['avg_loss']) <= abs(v1['avg_loss']):
    scores['V2'] += 20
else:
    scores['V1'] += 20

# äº¤æ˜“æ•ˆç‡ï¼ˆæ¥è¿‘50æ¬¡ï¼‰æƒé‡10%
trade_efficiency = {
    'V1': abs(v1['total_trades'] - 50),
    'V2': abs(v2['total_trades'] - 50),
    'V3': abs(v3['total_trades'] - 50)
}
best_efficiency = min(trade_efficiency.values())
for v in ['V1', 'V2', 'V3']:
    if trade_efficiency[v] == best_efficiency:
        scores[v] += 10
        break

print(f"\nç»¼åˆè¯„åˆ†ï¼ˆæ»¡åˆ†100ï¼‰:")
for v in ['V1', 'V2', 'V3']:
    print(f"  {v}: {scores[v]}åˆ†")

winner = max(scores, key=lambda x: scores[x])
print(f"\nğŸ† æœ€ä½³ç­–ç•¥: {winner}")

if winner == 'V3':
    print(f"\nâœ… V3ä¼˜åŠ¿:")
    if v3['total_pnl'] > max(v1['total_pnl'], v2['total_pnl']):
        print(f"  â€¢ æ€»æ”¶ç›Šæœ€é«˜: ${v3['total_pnl']:.2f}")
    if v3['profit_ratio'] > max(v1['profit_ratio'], v2['profit_ratio']):
        print(f"  â€¢ ç›ˆäºæ¯”æœ€ä¼˜: {v3['profit_ratio']:.2f}")
    if abs(v3['avg_loss']) < min(abs(v1['avg_loss']), abs(v2['avg_loss'])):
        print(f"  â€¢ é£é™©æ§åˆ¶æœ€å¥½: å¹³å‡äºæŸ${v3['avg_loss']:.2f}")
    print(f"  â€¢ MA20è¶‹åŠ¿è¿‡æ»¤æé«˜äº¤æ˜“è´¨é‡")
    print(f"  â€¢ äº¤æ˜“æ¬¡æ•°åˆç†: {v3['total_trades']}ç¬”")
    
    print(f"\nğŸ“ˆ å»ºè®®:")
    print(f"  1. âœ… ä½¿ç”¨V3å‚æ•°ä½œä¸ºå®ç›˜ç­–ç•¥")
    print(f"  2. ğŸ“Š ç”¨30å¤©ä»¥ä¸Šæ•°æ®éªŒè¯ç¨³å®šæ€§")
    print(f"  3. ğŸ’° è€ƒè™‘å°é¢å®ç›˜æµ‹è¯•")
    print(f"  4. ğŸ”„ æ ¹æ®å®ç›˜ç»“æœå¾®è°ƒå‚æ•°")

print("\n" + "="*80)
