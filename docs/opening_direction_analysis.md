# Opening Direction Decision Logic — Capital Flow Focus

此文档用于梳理本项目中用于开仓方向判断的核心逻辑，聚焦资金流（capital flow）信号的作用与优化空间。文中给出概念、信号集合、计算方法、决策规则、资本流优化策略以及验证计划，便于团队对方向判断的一致性与可解释性进行评估和迭代改进。

## 1. 总体目标
- 将价格信号与资金流信号结合，提升开仓方向的可靠性与鲁棒性。
- 在不同市场环境下（上涨/下跌/震荡）保持较高的方向预测准确率，同时把风险控制在可接受范围内。
- 通过可解释的阈值与多信号共识机制，降低单一信号导致的误导风险。

## 2. 数据来源与预处理
- 价格与交易量：来自交易所行情、K线、成交量与成交额。
- 资金流指标：常用的资金流度量包括资金流量指数（MFI）、资金流量分布（CMF）、OBV/VO统计、以及市场层面的资金流向数据（如行业/板块资金净流入、个股资金净流入等）。
- 融合周期：对流入流出信号使用不同时间窗（短期/中期/长期）进行对比，必要时进行对数或z-score标准化。
- 清洗与异常处理：剔除极端异常点、对缺失数据进行插值或跳过以避免错误信号。对信号进行归一化以便多信号融合。

## 3. 关键信号集合（ Capital Flow 维度）
- 短期资金净流入/流出方向信号：如 1D、5D 的净资金流，反映最近交易日的资金偏好。
- 资金流量指数（MFI）：考虑价格与成交量共同作用的动量型资金信号。
- 资金流通度量（CMF）：衡量成交金额与价格的对应关系，帮助识别买方/卖方主导。
- OBV 与 VPT：基于价格与成交量的叠加信号，捕捉趋势确认与价格背离。
- 跨周期资金流动（多周期资金流）：对比短期与中长期资金流，寻找信号一致性。可包含板块/行业资金流向作为辅助信号。

注：以上信号可组合使用，且不应单一依赖某一指标。优先考虑信号共识与一致性。

## 4. 开仓方向判断规则（简化版本）
- 输入：价格信号、资金流信号、成交量信号、风险约束。
- 输出：开多/开空/不建仓 的决策，以及相应的权重与信心程度。
- 核心原则：多信号共识优于单信号，且资金流信号对方向的贡献应与价格趋势相匹配。

### 4.1 信号融合与强度计算
### 4.2 决策阈值与共识规则

## 5. 品质与风险控制
- 仓位管理：根据信号强度分层分配仓位，避免因单次信号导致过度暴露。
- 止损与风控：为每笔开仓设定初始止损、最大回撤、以及动态风险阈值的触发条件。
- 流动性/滑点考量：在资金流信号强烈变化时，自动降低杠杆或降低开仓规模以控制滑点风险。
- 审计与可解释性：记录信号来源、时间窗、参数、阈值和决策理由，便于回看与复现。

## 6. 参数与阈值的优化方向（资金流为重点）
- 将资金流信号的权重随市场环境自适应调整：在高波动期降低对资金流的敏感度，转而依赖价格与成交量的稳健信号。
- 引入资金流方向强度的阈值带（如低/中/高）以降低在极端资金波动时的误导。
- 采用多时间窗一致性检验：若短中长期资金流方向不一致，降低开仓概率或触发观望。
- 结合跨品种/行业资金流趋势，以提升对宏观资金环境的把握。
- 引入后验评估：将信号回看至历史数据，统计方向命中率、精度、召回率等方向性指标，定期重估阈值。

## 7. 验证计划（Backtest/仿真）
- 数据切分：训练期/验证期/回滚期，覆盖不同市场阶段（牛市、熊市、震荡）。
- 指标：方向正确率、方向鲁棒性、夏普比率、最大回撤、胜率、期望收益等。
- 对比基线：仅使用价格信号；使用价格+资金流信号对比；使用全信号集合对比。
- 稳健性测试：对信号阈值进行网格搜索，观察性能敏感性。
- 解释性输出：提供每次开仓的信号来源、强度、阈值、权重与理由。

## 8. 风险与边界情况
- 在极端市场（流动性骤降、熔断等）下，优先观望，避免因资金流信号过度波动而造成损失。
- 当资金流指标异常（极端极值、缺失）时，禁用资金流信号或降低权重。
- 兼容性：确保与现有风控框架、资金管理模块无冲突。

## 9. 形式化伪代码（简化）
示例伪代码仅用于表达逻辑，非完整实现：

function decide_open_position(state):
  trend_score = compute_price_trend_score(state.price_history)
  flow_score  = compute_capital_flow_score(state.flow_history)
  volume_score = compute_volume_score(state.volume_history)
  total = w_price*trend_score + w_flow*flow_score + w_volume*volume_score

  signals = count_signals_consistent(state.signals)
  if total >= T_open and signals >= 2/3 and risk_allows(state):
    return OpenLong
  else if total <= -T_open and signals >= 2/3 and risk_allows(state):
    return OpenShort
  else
    return DoNothing

Notes: 这是高度抽象的实现框架，具体函数需要结合项目现有的数据结构与回测框架实现。

## 10. 附录
- 术语定义
- 数据字段与信号计算公式（MFI、CMF、OBV、VPT 等）
- 验证指标的计算方法

---
（此文档为初版，后续需结合代码实现与历史回测结果逐步细化阈值与权重）
