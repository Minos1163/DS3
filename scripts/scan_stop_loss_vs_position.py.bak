import os
import importlib.util
import pandas as pd
import matplotlib.pyplot as plt
from pathlib import Path
import numpy as np


def build_120d():
    os.makedirs('data', exist_ok=True)
    parts = []
    candidates = [
        'data/SOLUSDT_15m_60d.csv',
        'data/SOLUSDT_15m_30d.csv',
        'data/SOLUSDT_15m_15d.csv',
        'data/SOLUSDT_5m_15d.csv'
    ]

    for p in candidates:
        if not os.path.exists(p):
            continue
        df = __import__('pandas').read_csv(p, index_col='timestamp', parse_dates=True)
        if '5m' in os.path.basename(p):
            df = df.resample('15T').agg({'open':'first','high':'max','low':'min','close':'last','volume':'sum'}).dropna()
        parts.append(df)

    if not parts:
        print('未找到可用数据文件来构建 120 天样本（请提供数据）。')
        return None

    import pandas as pd
    df_all = pd.concat(parts)
    df_all = df_all[~df_all.index.duplicated(keep='first')]
    df_all = df_all.sort_index()
    out = 'data/SOLUSDT_15m_120d.csv'
    df_all.to_csv(out, index_label='timestamp')
    print(f'已保存: {out}')
    return out


def import_backtester_class():
    script_path = os.path.join(os.path.dirname(__file__), '..', 'tools', 'backtest', 'backtest_15m30d_v2.py')
    script_path = os.path.abspath(script_path)
    spec = importlib.util.spec_from_file_location('backtest_15m30d_v2', script_path)
    mod = importlib.util.module_from_spec(spec)
    spec.loader.exec_module(mod)
    return mod.ConservativeBacktester


def run_2d_scan(stop_losses, position_percents):
    build_120d()
    ConservativeBacktester = import_backtester_class()
    data_file = 'data/SOLUSDT_15m_120d.csv'
    results = []
    for p in position_percents:
        for sl in stop_losses:
            print(f'Run: pos={p:.2f}, stop_loss={sl:.4f}')
            bt = ConservativeBacktester(initial_capital=100.0, leverage=10.0)
            bt.position_percent = p
            bt.stop_loss_pct = sl
            df = bt.load_data(data_file)
            df = bt.calculate_indicators(df)
            bt.run_backtest(df)
            bt.analyze_results()

            trades_df = pd.DataFrame(bt.trades)
            total_pnl = trades_df['pnl'].sum() if not trades_df.empty else 0.0
            final_capital = bt.capital
            trades_count = len(bt.trades)
            if not trades_df.empty:
                cum = bt.initial_capital + trades_df['pnl'].cumsum()
                peak = cum.cummax()
                drawdown = ((peak - cum) / peak).max() * 100
            else:
                drawdown = 0.0

            results.append({'position_percent': p, 'stop_loss_pct': sl, 'final_capital': final_capital, 'total_pnl': total_pnl, 'trades': trades_count, 'max_drawdown_pct': drawdown})

    df_res = pd.DataFrame(results)
    out_csv = 'logs/stop_loss_vs_position_results.csv'
    Path('logs').mkdir(parents=True, exist_ok=True)
    df_res.to_csv(out_csv, index=False)
    print('Saved:', out_csv)

    # pivot for heatmap (rows=position, cols=stop_loss)
    pivot = df_res.pivot(index='position_percent', columns='stop_loss_pct', values='final_capital')
    plt.figure(figsize=(12,6))
    x = np.arange(pivot.shape[1])
    y = np.arange(pivot.shape[0])
    plt.imshow(pivot.values, aspect='auto', cmap='RdYlGn')
    plt.colorbar(label='Final capital')
    plt.xticks(ticks=x, labels=[f"{v*100:.2f}%" for v in pivot.columns], rotation=45)
    plt.yticks(ticks=y, labels=[f"{v*100:.1f}%" for v in pivot.index])
    plt.xlabel('Stop loss (%)')
    plt.ylabel('Position percent (%)')
    out_heat = 'logs/stop_loss_vs_position_heatmap.png'
    plt.tight_layout()
    plt.savefig(out_heat)
    print('Saved heatmap:', out_heat)

    # best point
    best = df_res.loc[df_res['final_capital'].idxmax()]
    print('Best configuration:', best.to_dict())
    best_file = 'logs/stop_loss_vs_position_best.txt'
    Path(best_file).write_text(str(best.to_dict()), encoding='utf-8')
    print('Saved best config:', best_file)
    return df_res


def main():
    # stop losses from 0.5% to 3.0% step 0.25% (0.0025)
    stop_losses = [round(x,6) for x in list(np.arange(0.005, 0.0301, 0.0025))]
    position_percents = [0.10, 0.15, 0.20, 0.25, 0.30, 0.35, 0.40]
    res = run_2d_scan(stop_losses, position_percents)
    print('\nScan complete. Results saved to logs/')


if __name__ == '__main__':
    main()
